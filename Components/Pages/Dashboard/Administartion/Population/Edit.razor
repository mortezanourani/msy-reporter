@page "/Dashboard/Administration/Population/Edit/{Id:guid}"

@* @rendermode InteractiveServer *@

@layout _Layout

<PageTitle>ویرایش جمعیت</PageTitle>

<div class="page-top-menu">
    <h6 class="panel-title">ویرایش اطلاعات جمعیتی شهرستان</h6>
    <div class="top-menu-links">
        <NavLink class="panel-link" href="/Dashboard/Administration/Population">بازگشت به فهرست جمعیت</NavLink>
    </div>
</div>

<div class="row form-wrapper">
    <div class="col3-5 mb-0">
        <div class="instructions">
            <p class="mb-3">فرم مقابل جهت ثبت اطلاعات باشگاه های ورزشی خصوصی بر اساس پروانه فعالیت صادر شده از سامانه طراحی شده است.</p>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/title-blue.svg">
                    <h6>عنوان باشگاه:</h6>
                </div>
                <p>عنوان باشگاه بر اساس پروانه فعالیت صادر شده از درگاه ملی مجوزها</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/verified-blue.svg">
                    <h6>وضعیت باشگاه:</h6>
                </div>
                <p>وضعیت فعالیت باشگاه به صورت یک کلید دو حالته قابل تنظیم است.</p>
                <p>چنانچه کلید در حالت قرمز باشد به معنی غیرفعال بودن باشگاه خواهد بود، و در صورتی که باشگاه فعال باشد لطفا کلید مربوطه را در وضعیت سبز قرار دهید.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/location-map-blue.svg">
                    <h6>بخش / روستا:</h6>
                </div>
                <p>در صورتی که باشگاه مربوطه در بخش یا روستا است لطفا نام بخش یا روستا را وارد نمایید.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/location-blue.svg">
                    <h6>آدرس پستی:</h6>
                </div>
                <p>آدرس پستی محل باشگاه ورزشی مربوطه که در گواهی تاییدیه کد پستی درج شده است.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/zipcode-blue.svg">
                    <h6>کد پستی:</h6>
                </div>
                <p>کد پستی ده رقمی محل باشگاه یا دفتر باشگاه بر اساس تاییدیه کد پستی ارائه شده بدون خط فاصله و فقط با ده رقم وارد گردد.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/phone-blue.svg">
                    <h6>شماره تلفن باشگاه:</h6>
                </div>
                <p>شماره تلفن مربوط به تلفن ثابت باشگاه بوده و ترجیحا به همراه کد استان ثبت گردد.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/area-blue.svg">
                    <h6>مساحت:</h6>
                </div>
                <p>مساحت باشگاه در سه بخش مساحت کل (مجموع فضای سرپوشیده و روباز)، مساحت فضای سرپوشیده و مساحت فضای روباز در نظر گرفته شده است.</p>
                <p>چنانچه باشگاه فاقد فضای سرپوشیده یا فاقد فضای روباز بوده و مساحت یکی از این دو فضا صفر باشید، فیلد مربوطه می تواند خالی باشد.</p>
            </div>
        </div>
    </div>
    <div class="col2-5 mb-auto">
        @if (Cities is null)
        {
            <Loading CardMode=true />
        }
        else
        {
            <div class="card p-3">
                <EditForm method="post" Model="Population" OnValidSubmit="UpdatePopulation" FormName="edit" Enhance>
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" role="alert" />
                    <div class="form-row">
                        <div class="form-group fa mb-3">
                            <label for="cityid" class="form-label">
                                <img src="/icons/dropdown.svg" />
                            </label>
                            <InputSelect id="cityid" class="select form-control" @bind-Value="Population.CityId">
                                @foreach (City city in Cities!)
                                {
                                    <option value="@city.Id">@city.PersianName</option>
                                }
                            </InputSelect>
                            <InputNumber @bind-Value="Population.CityId" class="form-control" hidden />
                        </div>
                        <div class="form-group en mb-3">
                            <label for="year" class="form-label">
                                <img src="/icons/calendar.svg" />
                            </label>
                            <InputNumber id="year" @bind-Value="Population.Year" class="form-control" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">جمعیت شهری:</label>
                    </div>
                    <div class="form-row">
                        <div class="form-group en mb-3">
                            <label for="urbanmen" class="form-label">
                                <img src="/icons/man.svg" />
                            </label>
                            <InputNumber id="urbanmen" @bind-Value="Population.UrbanMen" class="form-control" />
                        </div>
                        <div class="form-group en mb-3">
                            <label for="urbanwomen" class="form-label">
                                <img src="/icons/woman.svg" />
                            </label>
                            <InputNumber id="urbanwomen" @bind-Value="Population.UrbanWomen" class="form-control" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label class="form-label">جمعیت روستایی:</label>
                    </div>
                    <div class="form-row">
                        <div class="form-group en mb-3">
                            <label for="ruralmen" class="form-label">
                                <img src="/icons/man.svg" />
                            </label>
                            <InputNumber id="ruralmen" @bind-Value="Population.RuralMen" class="form-control" />
                        </div>
                        <div class="form-group en mb-3">
                            <label for="ruralwomen" class="form-label">
                                <img src="/icons/woman.svg" />
                            </label>
                            <InputNumber id="ruralwomen" @bind-Value="Population.RuralWomen" class="form-control" />
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">ثبت</button>
                </EditForm>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public Guid? Id { get; set; }

    [SupplyParameterFromForm]
    private Population? Population { get; set; }

    private List<City>? Cities { get; set; }

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Cities = await context.Cities
            .Where(city => city.Id != 0)
            .ToListAsync();

        Population = await context.Population
            .Include(m => m.City)
            .FirstOrDefaultAsync(m => m.Id == Id!);
    }

    private async Task UpdatePopulation()
    {
        using var context = DbFactory.CreateDbContext();
        context.Attach(Population!).State = EntityState.Modified;
        await context.SaveChangesAsync();
        NavigationManager.NavigateTo("/Dashboard/Administration/Population");
    }
}
