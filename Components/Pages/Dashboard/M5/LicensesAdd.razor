@page "/Dashboard/M5/Licenses/Add/{FacilityId:guid}"

@rendermode InteractiveServer

@layout _Layout

<PageTitle>مجوز باشگاه ماده 5</PageTitle>

<AuthorizeView Roles="Administrators" Context="authContext">
    <div class="row form-wrapper">
        <div class="col3-5 mb-0">
            <div class="instructions">
                <p class="mb-3">دوره ها و کلاس های آموزشی ضمن خدمت با اطلاعات ذیل در سامانه آماری اداره کل ورزش و جوانان استان گیلان ثبت می گردد.</p>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/title-blue.svg">
                        <h6>عنوان دوره:</h6>
                    </div>
                    <p>در فرم مربوطه بخش اول اطلاعات عنوان دوره آموزشی مورد نظر است.</p>
                    <p>در این بخش عنوان دوره، نوع دوره بین عمومی یا تخصصی (شغلی) و نحوه برگزاری دوره از نظر مجازی یا حضوری قابل ویرایش می باشد.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/duration-blue.svg">
                        <h6>مدت دوره (ساعت):</h6>
                    </div>
                    <p>در بخش بعدی مدت دوره آموزشی را برحسب ساعت مشخص می کنید. بدیهی است که در حالت پیشفرض مقدار مدت دوره صفر در نظر گرفته شده است.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/calendar-blue.svg">
                        <h6>تاریخ برگزاری دوره:</h6>
                    </div>
                    <p>تاریخ برگزاری دوره در دو بخش ماه و سال در سامانه ذخیره می گردد. سال برگزاری دوره به صورت چهار رقمی و ماه برگزاری دوره به صورت دو رقمی وارد می شود.</p>
                </div>
            </div>
        </div>
        <div class="col2-5 mb-auto">
            @if (UsersGenders is null)
            {
                <Loading CardMode=true />
            }
            else
            {
                <div class="card p-3">
                    <EditForm method="post" Model="License" OnValidSubmit="AddLicense" FormName="create" Enhance>
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" role="alert" />
                        <input type="hidden" name="License.FacilityId" value="@FacilityId" />
                        <div class="form-row">
                            <div class="form-checkbox mb-3">
                                <label for="isbeneficial" class="form-label">
                                    <span class="checked">حقیقی</span>
                                    <span class="unchecked">حقوقی</span>
                                </label>
                                <InputCheckbox id="isbeneficial" @bind-Value="IsBeneficial" class="form-check-input" hidden />
                            </div>
                            <div class="form-checkbox mb-3">
                                <label for="isowner" class="form-label">
                                    <span class="checked">تملیکی</span>
                                    <span class="unchecked">استیجاری</span>
                                </label>
                                <InputCheckbox id="isowner" @bind-Value="IsOwner" class="form-check-input" hidden />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="serial" class="form-label">
                                    <img src="/icons/qrcode.svg" />
                                </label>
                                <InputText id="serial" @bind-Value="License.Serial" class="form-control" placeholder="شماره مجوز" />
                            </div>
                            <div class="form-checkbox mb-3">
                                <label for="isrenewal" class="form-label">
                                    <span class="checked">تمدید</span>
                                    <span class="unchecked">تاسیس</span>
                                </label>
                                <InputCheckbox id="isrenewal" @bind-Value="IsRenewal" class="form-check-input" hidden />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="startdate" class="form-label">
                                    <img src="/icons/calendar.svg" />
                                </label>
                                <InputText id="startdate" @bind-Value="License.StartDate" class="form-control" placeholder="تاریخ صدور" />
                            </div>
                            <div class="form-group en mb-3">
                                <label for="expiredate" class="form-label">
                                    <img src="/icons/calendar.svg" />
                                </label>
                                <InputText id="expiredate" @bind-Value="License.ExpireDate" class="form-control" placeholder="تاریخ انقضا" />
                            </div>
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="usersgenderid" class="form-label">
                                <img src="/icons/genders.svg" />
                            </label>
                            <InputSelect id="usersgenderid" @bind-Value="License.UsersGenderId" class="select form-control">
                                @foreach(UsersGender gender in UsersGenders!)
                                {
                                    <option value="@gender.Id">@gender.PersianName</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="mensports" class="form-label">
                                <img src="/icons/man.svg" />
                            </label>
                            <InputText id="mensports" @bind-Value="License.MenSports" class="form-control" placeholder="رشته های ورزشی آقایان" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="womensports" class="form-label">
                                <img src="/icons/woman.svg" />
                            </label>
                            <InputText id="womensports" @bind-Value="License.WomenSports" class="form-control" placeholder="رشته های ورزشی بانوان" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="company" class="form-label">
                                <img src="/icons/organization.svg" />
                            </label>
                            <InputText id="company" @bind-Value="License.Company" class="form-control" placeholder="مالک حقوقی (ارگان / سازمان / شرکت خصوصی)" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="name" class="form-label">
                                <img src="/icons/user.svg" />
                            </label>
                            <InputText id="name" @bind-Value="License.Name" class="form-control" placeholder="نام و نام خانوداگی موسس" />
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="seencode" class="form-label">
                                    <img src="/icons/idcard.svg" />
                                </label>
                                <InputText id="seencode" @bind-Value="License.SeenCode" class="form-control" placeholder="کد ملی موسس" />
                            </div>
                            <div class="form-group en mb-3">
                                <label for="phone" class="form-label">
                                    <img src="/icons/phone.svg" />
                                </label>
                                <InputText id="phone" @bind-Value="License.Phone" class="form-control" placeholder="شماره تماس موسس" />
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <div class="alert alert-@statusMessageClass" role="alert">
                                @statusMessage
                            </div>
                        }
                        <button type="submit" class="btn btn-primary w-100">ثبت</button>
                    </EditForm>
                </div>
            }
        </div>
    </div>
</AuthorizeView>

@code {
    [Parameter]
    public Guid FacilityId { get; set; }

    private bool IsBeneficial;
    private bool IsOwner;
    private bool IsRenewal;

    private AppDbContext? context { get; set; } = default!;

    private List<UsersGender>? UsersGenders;

    private string? statusMessage;
    private string? statusMessageClass;

    [SupplyParameterFromForm]
    private PrivateFacilityLicense License { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        UsersGenders = await context.UsersGenders
            .OrderBy(gender => gender.Id)
            .ToListAsync();
    }

    private async Task AddLicense()
    {
        statusMessage = $"Start...";
        License.FacilityId = FacilityId;
        License.IsBeneficial = IsBeneficial;
        License.IsOwner = IsOwner;
        License.IsRenewal = IsRenewal;

        context = DbFactory.CreateDbContext();
        try
        {
            context.PrivateFacilityLicenses.Add(License);
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo($"/Dashboard/M5/Edit/{FacilityId}");
        }
        catch (Exception exception)
        {
            statusMessage = exception.InnerException!.Message;
            return;
        }
    }
}
