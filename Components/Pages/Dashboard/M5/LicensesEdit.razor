@page "/Dashboard/M5/Licenses/Edit/{Id:guid}"

@rendermode InteractiveServer

@layout _Layout

<PageTitle>مجوز باشگاه ماده 5</PageTitle>

<div class="page-top-menu">
    <h6 class="panel-title">ویرایش پروانه فعالیت باشگاه @License?.Facility.Name شهرستان @License?.Facility.City.PersianName</h6>
    <span class="top-menu-links">
        <a class="panel-link" href="/Dashboard/M5/Edit/@License?.FacilityId">
            بازگشت به صفحه ویرایش باشگاه
        </a>
    </span>
</div>

<AuthorizeView Roles="Administrators" Context="authContext">
    <div class="row form-wrapper">
        <div class="col3-5 mb-0">
            <div class="instructions">
                <p class="mb-3">پروانه فعالیت باشگاه های ماده 5 بر اساس مجوز صادر شده از درگاه ملی مجوزها در سامانه آماری اداره کل ورزش و جوانان استان گیلان ثبت می گردد.</p>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/qrcode-blue.svg">
                        <h6>شماره پروانه فعالیت:</h6>
                    </div>
                    <p>شماره پروانه فعالیت باشگاه بر اساس مجوز صادر شده از درگاه ملی مجوزها.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/calendar-blue.svg">
                        <h6>تاریخ صدور و انقضا:</h6>
                    </div>
                    <p>تاریخ صدور و اتمام مجوز بر اساس مجوز صادر شده از درگاه ملی مجوزها به صورت ده کاراکتر وارد می گردد.</p>
                    <p>لطفا تاریخ ها را به صورت چهاررقم سال، دو رقم ماه و دو رقم روز با خط فاصله از هم جدا نمایید.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/calendar-blue.svg">
                        <h6>تاریخ برگزاری دوره:</h6>
                    </div>
                    <p>تاریخ برگزاری دوره در دو بخش ماه و سال در سامانه ذخیره می گردد. سال برگزاری دوره به صورت چهار رقمی و ماه برگزاری دوره به صورت دو رقمی وارد می شود.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/genders-blue.svg">
                        <h6>جنسیت استفاده کنندگان:</h6>
                    </div>
                    <p>لطفا جنسیت استفاده کنندگان از باشگاه مربوطه را بر اساس پروانه فعالیت آن از منوی کشویی انتخاب نمایید.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/man-blue.svg">
                        <h6>و</h6>
                        <img src="/icons/woman-blue.svg">
                        <h6>رشته های ورزشی:</h6>
                    </div>
                    <p>رشته های ورزشی ثبت شده در پروانه فعالیت باشگاه را به تفکیک آقایان و بانوان به صورت جدا شده با ویرگول (،) ثبت نمایید.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/organization-blue.svg">
                        <h6>عنوان مالک حقوقی:</h6>
                    </div>
                    <p>در صورتی که مجوز به صورت حقوقی ثبت شده است لطفا عنوان ارگان، سازمان یا شرکت صاحب مجوز را وارد نمایید.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/user-blue.svg">
                        <h6>نام و نام خانوادگی موسس:</h6>
                    </div>
                    <p>نام و نام خانوادگی موسس باشگاه الزامی بوده و لطفا در هر دو حالت حقیقی و حقوقی ثبت گردد.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/idcard-blue.svg">
                        <h6>کد ملی موسس:</h6>
                    </div>
                    <p>کد ملی موسس جهت جستجو در فهرست باشگاه های ماده 5 مورد استفاده قرار خواهد گرفت.</p>
                    <p>چنانچه کد ملی موسس در مجوزهای حقوقی در دسترس نبود می توانید از شناسه ملی شرکت یا سازمان مربوطه استفاده نمایید.</p>
                </div>
                <div class="instruction-item">
                    <div class="icon-title mb-2">
                        <img src="/icons/phone-blue.svg">
                        <h6>شماره تماس موسس:</h6>
                    </div>
                    <p>شماره تماس موسس، همان شماره تلفن همراه موسس می باشد.</p>
                    <p>در خصوص پروانه های حقوقی، لطفا شماره تلفن همراه مدیرعامل یا مدیر هماهنگی های ارگان، سازمان یا شرکت مربوطه وارد گردد.</p>
                </div>
            </div>
        </div>
        <div class="col2-5 mb-auto">
            @if (UsersGenders is null || License is null)
            {
                <Loading CardMode=true />
            }
            else
            {
                <div class="card p-3">
                    <EditForm method="post" Model="License" OnValidSubmit="UpdateLicense" FormName="edit" Enhance>
                        <DataAnnotationsValidator />
                        <input type="hidden" name="License.Id" value="@Id" />
                        <input type="hidden" name="License.FacilityId" value="@License.FacilityId" />
                        <div class="form-row">
                            <div class="form-checkbox mb-3">
                                <label for="isbeneficial" class="form-label">
                                    <span class="checked">حقیقی</span>
                                    <span class="unchecked">حقوقی</span>
                                </label>
                                <InputCheckbox id="isbeneficial" @bind-Value="IsBeneficial" class="form-check-input" hidden />
                            </div>
                            <div class="form-checkbox mb-3">
                                <label for="isowner" class="form-label">
                                    <span class="checked">تملیکی</span>
                                    <span class="unchecked">استیجاری</span>
                                </label>
                                <InputCheckbox id="isowner" @bind-Value="IsOwner" class="form-check-input" hidden />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="serial" class="form-label">
                                    <img src="/icons/qrcode.svg" />
                                </label>
                                <InputText id="serial" @bind-Value="License.Serial" class="form-control" placeholder="شماره مجوز" />
                            </div>
                            <div class="form-checkbox mb-3">
                                <label for="isrenewal" class="form-label">
                                    <span class="checked">تمدید</span>
                                    <span class="unchecked">تاسیس</span>
                                </label>
                                <InputCheckbox id="isrenewal" @bind-Value="IsRenewal" class="form-check-input" hidden />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="startdate" class="form-label">
                                    <img src="/icons/calendar.svg" />
                                </label>
                                <InputText id="startdate" @bind-Value="License.StartDate" class="form-control" placeholder="تاریخ صدور" />
                            </div>
                            <div class="form-group en mb-3">
                                <label for="expiredate" class="form-label">
                                    <img src="/icons/calendar.svg" />
                                </label>
                                <InputText id="expiredate" @bind-Value="License.ExpireDate" class="form-control" placeholder="تاریخ انقضا" />
                            </div>
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="usersgenderid" class="form-label">
                                <img src="/icons/genders.svg" />
                            </label>
                            <InputSelect id="usersgenderid" @bind-Value="License.UsersGenderId" class="select form-control">
                                @foreach(UsersGender gender in UsersGenders!)
                                {
                                    <option value="@gender.Id">@gender.PersianName</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="mensports" class="form-label">
                                <img src="/icons/man.svg" />
                            </label>
                            <InputText id="mensports" @bind-Value="License.MenSports" class="form-control" placeholder="رشته های ورزشی آقایان" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="womensports" class="form-label">
                                <img src="/icons/woman.svg" />
                            </label>
                            <InputText id="womensports" @bind-Value="License.WomenSports" class="form-control" placeholder="رشته های ورزشی بانوان" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="company" class="form-label">
                                <img src="/icons/organization.svg" />
                            </label>
                            <InputText id="company" @bind-Value="License.Company" class="form-control" placeholder="مالک حقوقی (ارگان / سازمان / شرکت خصوصی)" />
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="name" class="form-label">
                                <img src="/icons/user.svg" />
                            </label>
                            <InputText id="name" @bind-Value="License.Name" class="form-control" placeholder="نام و نام خانوداگی موسس" />
                        </div>
                        <div class="form-row">
                            <div class="form-group en mb-3">
                                <label for="seencode" class="form-label">
                                    <img src="/icons/idcard.svg" />
                                </label>
                                <InputText id="seencode" @bind-Value="License.SeenCode" class="form-control" placeholder="کد ملی موسس" />
                            </div>
                            <div class="form-group en mb-3">
                                <label for="phone" class="form-label">
                                    <img src="/icons/phone.svg" />
                                </label>
                                <InputText id="phone" @bind-Value="License.Phone" class="form-control" placeholder="شماره تماس موسس" />
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(statusMessage))
                        {
                            <div class="alert alert-danger" role="alert">
                                @statusMessage
                            </div>
                        }
                        <ValidationSummary class="text-danger" role="alert" />
                        <button type="submit" class="btn btn-primary w-100">ثبت</button>
                    </EditForm>
                </div>
            }
        </div>
    </div>
</AuthorizeView>

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool IsBeneficial;
    private bool IsOwner;
    private bool IsRenewal;

    private AppDbContext? context { get; set; } = default!;

    private List<UsersGender>? UsersGenders;

    private string? statusMessage;

    [SupplyParameterFromForm]
    private PrivateFacilityLicense? License { get; set; }

    protected override async Task OnInitializedAsync()
    {
        context = DbFactory.CreateDbContext();
        UsersGenders = await context.UsersGenders
            .OrderBy(gender => gender.Id)
            .ToListAsync();

        License = await context.PrivateFacilityLicenses
            .Include(license => license.Facility)
                .ThenInclude(facility => facility.City)
            .FirstOrDefaultAsync(license => license.Id == Id);

        if (License is null)
        {
            NavigationManager.NavigateTo("notfound");
        }

        IsBeneficial = License!.IsBeneficial.GetValueOrDefault();
        IsOwner = License!.IsOwner.GetValueOrDefault();
        IsRenewal = License!.IsRenewal.GetValueOrDefault();
    }

    private async Task UpdateLicense()
    {
        if (License is null)
        {
            NavigationManager.NavigateTo("notfound");
        }

        context = DbFactory.CreateDbContext();

        License.IsBeneficial = IsBeneficial;
        License.IsOwner = IsOwner;
        License.IsRenewal = IsRenewal;
        License.UsersGender = context.UsersGenders.FirstOrDefault(gender => gender.Id == License!.UsersGenderId)!;

        context.Attach(License!).State = EntityState.Modified;
        
        try
        {
            await context.SaveChangesAsync();
            NavigationManager.NavigateTo($"/Dashboard/M5/Edit/{License.FacilityId}");
        }
        catch (Exception exception)
        {
            statusMessage = exception.InnerException!.Message;
            return;
        }
    }
}
