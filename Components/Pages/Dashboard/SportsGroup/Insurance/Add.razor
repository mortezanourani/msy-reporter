@page "/Dashboard/SportsGroup/Insurance/Add"

@using Microsoft.EntityFrameworkCore
@using System.Globalization

<PageTitle>ورزشکاران سازمان یافته</PageTitle>

<div class="page-top-menu">
    <h6 class="panel-title">ثبت آمار ورزشکاران سازمان یافته</h6>
</div>

<div class="row form-wrapper">
    <div class="col3-5 mb-0">
        <div class="instructions">
            <p class="mb-0">در فرم مقابل آمار ورزشکاران سازمان یافته بر اساس هر هیات در هر شهرستان مربوط به ماه مشخصی ثبت می شوند.</p>
            <p class="mb-3">بدیهی است که آمار مربوطه معادل تعداد ورزشکاران آقا و خانم بیمه شده از ابتدای ماه تا انتهای همان خواهد بود.</p>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/calendar-blue.svg">
                    <h6>ماه و سال:</h6>
                </div>
                <p>ماه و سال مربوط به آماری که قصد ثبت آن را دارید از دو منوی کشویی در فرم مقابل قابل تنظیم هستند.</p>
                <p>لازم به ذکر است که با توجه به اینکه آمار باید به صورت ماهیانه ثبت گردد لذا دسترسی در بخش سال تنها برای سال جاری و سال گذشته امکان پذیر است.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/man-blue.svg">
                    <h6>تعداد بیمه های ورزشی آقایان:</h6>
                </div>
                <p>تعداد ورزشکاران سازمان یافته آقایان که با آیکون بالا مشخص شده است به صورت عددی ثبت می گردد.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <img src="/icons/woman-blue.svg">
                    <h6>تعداد بیمه های ورزشی بانوان:</h6>
                </div>
                <p>تعداد ورزشکاران سازمان یافته بانوان که با آیکون بالا مشخص شده است به صورت عددی ثبت می گردد.</p>
            </div>
            <div class="instruction-item">
                <div class="icon-title mb-2">
                    <h6>تذکر:</h6>
                </div>
                <p>فرم به گونه ای طراحی شده است که پس از ثبت آمار یک هیات در تاریخ مشخصی نیاز به رفرش کردن صفحه نبوده و می توانید دیگر آمارها را نیز وارد نمایید.</p>
                <p>همچنین چنانچه تعداد ورزشکاران سازمان یافته هیات مربوطه برای ماه و سال انتخاب شده در فرم قبلا ثبت شده باشد، خطایی در خصوص عدم امکان ثبت اطلاعات جدید، نمایش داده خواهد شد.</p>
            </div>
        </div>
    </div>
    <div class="col2-5 mb-auto">
        @if (Cities is null || Federations is null)
        {
            <Loading CardMode=true />
        }
        else
        {
            <div class="card p-3">
                <EditForm method="post" Model="Insurance" OnValidSubmit="AddInsurance" FormName="create" Enhance>
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" role="alert" />
                    <div class="form-row">
                        <div class="form-group fa mb-3">
                            <label for="cityid" class="form-label">
                                <img src="/icons/dropdown.svg" />
                            </label>
                            <InputSelect id="cityid" @bind-Value="Insurance.CityId" class="form-control">
                                @foreach (City city in Cities!)
                                {
                                    <option value="@city.Id">@city.PersianName</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group fa mb-3">
                            <label for="federationid" class="form-label">
                                <img src="/icons/dropdown.svg" />
                            </label>
                            <InputSelect id="federationid" @bind-Value="Insurance.FederationId" class="form-control">
                                @foreach (Federation federation in Federations!)
                                {
                                    <option value="@federation.Id">@federation.PersianName</option>
                                }
                            </InputSelect>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group en mb-3">
                            <label for="month" class="form-label">
                                <img src="/icons/calendar.svg" />
                            </label>
                            <InputSelect id="month" @bind-Value="Insurance.Month" class="form-control">
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <option value="@i">@($"{i:00}")</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="form-group en mb-3">
                            <label for="year" class="form-label">
                                <img src="/icons/calendar.svg" />
                            </label>
                            <InputSelect id="year" @bind-Value="Insurance.Year" class="form-control">
                                @{
                                    PersianCalendar persianCalendar = new PersianCalendar();
                                    int currentYear = persianCalendar.GetYear(DateTime.Now);
                                    for (int i = currentYear; i >= currentYear - 1; i--)
                                    {
                                        <option value="@i">@i</option>
                                    }
                                }
                            </InputSelect>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group en mb-3">
                            <label for="mencount" class="form-label">
                                <img src="/icons/man.svg" />
                            </label>
                            <InputNumber id="mencount" @bind-Value="Insurance.MenCount" class="form-control" />
                        </div>
                        <div class="form-group en mb-3">
                            <label for="womencount" class="form-label">
                                <img src="/icons/woman.svg" />
                            </label>
                            <InputNumber id="womencount" @bind-Value="Insurance.WomenCount" class="form-control" />
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(statusMessage))
                    {
                        <div class="alert alert-@statusMessageClass" role="alert">
                            @statusMessage
                        </div>
                    }
                    <button type="submit" class="btn btn-primary w-100">ثبت</button>
                </EditForm>
            </div>
        }
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private Insurance Insurance { get; set; } = new();

    private List<City>? Cities;
    private List<Federation>? Federations;

    private string? statusMessage;
    private string? statusMessageClass;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();

        Cities = await context.Cities
            .Where(city => city.Id != 0)
            .ToListAsync();

        Federations = await context.Federations
            .ToListAsync();
    }

    private async Task AddInsurance()
    {
        using var context = DbFactory.CreateDbContext();

        context.Insurances.Add(Insurance);

        try
        {
            await context.SaveChangesAsync();
            statusMessageClass = "success";
            statusMessage = $"اطلاعات وارد شده با موفقیت ثبت شد.";
        }
        catch (Exception exception)
        {
            statusMessageClass = "danger";
            statusMessage = $"{exception.InnerException!.Message}";
        }

        return;
    }
}
