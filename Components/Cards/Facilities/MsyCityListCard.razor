@using Microsoft.AspNetCore.Components.QuickGrid

<div class="card list-card">
    <div class="card-header">
        <h6 class="title">اماکن دولتی ورزش و جوانان @City?.PersianName</h6>
        @if (msyFacilities is not null)
        {
            <div class="paginator">
                <nav role="navigation">
                    @if (pagination.TotalItemCount.HasValue)
                    {
                        var totalPages = pagination.TotalItemCount;
                        var pageIndex = pagination.CurrentPageIndex;
                        var currentPage = pageIndex + 1;
                        var lastPage = pagination.LastPageIndex + 1;
                        var firstItemNumber = 1 + (pagination.ItemsPerPage * pagination.CurrentPageIndex);
                        var lastItemNumber = pagination.ItemsPerPage * (pagination.CurrentPageIndex + 1);
                        <button @onclick="@(() => GoToPageAsync(pageIndex + 1))"
                                class="btn"
                                aria-current="@AriaCurrentValue(pageIndex + 1)"
                                aria-label="@(pageIndex + 1)"
                                disabled=@((currentPage >= lastPage) ? "disabled" : false)>
                            <img src="/icons/arrow-left.svg" />
                        </button>
                        <div class="total">@string.Format("صفحه {0} از {1}", currentPage, lastPage)</div>
                        <button @onclick="@(() => GoToPageAsync(pageIndex - 1))"
                                class="btn"
                                aria-current="@AriaCurrentValue(pageIndex - 1)"
                                aria-label="@(pageIndex - 1)"
                                disabled=@((pageIndex <= 0) ? "disabled" : false)>
                            <img src="/icons/arrow-right.svg" />
                        </button>
                    }
                </nav>
            </div>
        }
    </div>
    @if (msyFacilities is null)
    {
        <Loading />
    }
    else
    {
        <div class="card-body">
            <div class="table-wrapper">
                <QuickGrid Items="msyFacilities!.AsQueryable()" Pagination="pagination" Theme="" Class="quickgrid-table">
                    <PropertyColumn IsDefaultSortColumn="true" Title="عنوان باشگاه" Property="@(facility => facility.Name)" />
                    <PropertyColumn Title="نوع مکان" Property="@(facility => facility.TypeId != null ? facility.Type!.PersianTitle : "نامشخص")" />
                    <PropertyColumn Title="موقیعت جغرافیایی" Property="@(facility => facility.IsRural == true ? "روستایی" : "شهری")" />
                    <TemplateColumn>
                        <a class="info-link" href="/Facilities/@context.Id">
                            <img src="/icons/info.svg" />
                        </a>
                    </TemplateColumn>
                </QuickGrid>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int? CityId { get; set; }

    private City? City = null!;

    private List<Facility>? msyFacilities;

    protected override async Task OnParametersSetAsync()
    {
        msyFacilities = null;

        using var context = DbFactory.CreateDbContext();

        City = await context.Cities
            .FirstOrDefaultAsync(m => m.Id == CityId!);

        if (City is not null)
        {
            msyFacilities = await context.Facilities
                .Include(facility => facility.City)
                    .Include(facility => facility.FacilityDocuments)
                    .Include(facility => facility.FacilityContracts)
                    .Include(facility => facility.Type)
                    .Where(facility => facility.City.Id == City.Id)
                    .ToListAsync();
        }

        pagination.TotalItemCountChanged += (sender, eventArgs) => StateHasChanged();
    }

    private PaginationState pagination = new PaginationState { ItemsPerPage = 10 };

    private async Task GoToPageAsync(int pageIndex)
    {
        await pagination.SetCurrentPageIndexAsync(pageIndex);
    }

    private string? PageButtonClass(int pageIndex)
        => pagination.CurrentPageIndex == pageIndex ? "current" : null;

    private string? AriaCurrentValue(int pageIndex)
        => pagination.CurrentPageIndex == pageIndex ? "page" : null;
}
